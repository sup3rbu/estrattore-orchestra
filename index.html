<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disney Status Lotto</title>
    <style>
        :root { --primary: #6366f1; --accent: #f59e0b; --bg: #f8fafc; --card: #ffffff; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 20px; margin: 0; }
        .container { background: var(--card); padding: 2rem; border-radius: 24px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); width: 100%; max-width: 500px; text-align: center; }
        
        /* Display */
        .slot { height: 100px; margin: 20px 0; }
        #numero-estratto { font-size: 4rem; font-weight: 800; color: var(--primary); margin: 0; }
        #nome-estratto { font-size: 1.2rem; color: var(--accent); font-weight: 600; }
        .rolling { animation: blur 0.1s infinite; }
        @keyframes blur { 0% { opacity: 0.5; transform: scale(0.95); } 100% { opacity: 1; transform: scale(1); } }

        button { width: 100%; padding: 15px; font-size: 1.1rem; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; background: var(--primary); color: white; transition: 0.2s; }
        button:disabled { background: #e2e8f0; color: #94a3b8; cursor: not-allowed; }

        /* Griglie con stato */
        .section-title { font-size: 0.75rem; text-transform: uppercase; color: #94a3b8; margin: 25px 0 10px; text-align: left; }
        .grid { display: flex; flex-wrap: wrap; gap: 8px; }
        .box { padding: 6px 12px; border-radius: 8px; font-size: 0.8rem; font-weight: 600; border: 1px solid #e2e8f0; transition: 0.3s; }
        
        /* Colori basati sullo stato */
        .rimanente { background: #f1f5f9; color: #64748b; }
        .estratto { background: #dcfce7; color: #15803d; border-color: #bbf7d0; text-decoration: line-through; opacity: 0.7; }
        .box span { display: block; font-size: 0.6rem; text-decoration: none !important; }
    </style>
</head>
<body>

    <div class="container">
        <h2 style="color:#1e293b; margin:0;">Disney Lotto Status</h2>
        
        <div class="slot">
            <p id="numero-estratto">--</p>
            <p id="nome-estratto">Caricamento...</p>
        </div>
        
        <button id="btn-estrai" onclick="avviaEstrazione()" disabled>GIOCA</button>
        <p id="messaggio" style="font-size:0.8rem; color:#94a3b8; margin-top:10px;"></p>

        <div class="section-title">ðŸ“Š Tutti i personaggi (Stato in tempo reale)</div>
        <div id="lista-totale" class="grid"></div>
    </div>

    <script>
        let personaggiiDB = [];
        const ATTESA_MS = 5000;

        async function init() {
            try {
                // Se non ci sono dati nel browser, caricali dal JSON
                const salvati = localStorage.getItem('db_disney');
                
                if (salvati) {
                    personaggiiDB = JSON.parse(salvati);
                } else {
                    const response = await fetch('nomi.json');
                    personaggiiDB = await response.json();
                    salvaDati();
                }
                
                document.getElementById('nome-estratto').innerText = "Pronto all'estrazione";
                aggiornaUI();
            } catch (e) {
                document.getElementById('nome-estratto').innerText = "Errore caricamento nomi.json";
            }
        }

        function salvaDati() {
            localStorage.setItem('db_disney', JSON.stringify(personaggiiDB));
        }

        function aggiornaUI() {
            const listaDiv = document.getElementById('lista-totale');
            const ultima = parseInt(localStorage.getItem('ultimo_ts')) || 0;
            const ultimoID = localStorage.getItem('ultimo_id');

            // Mostriamo l'ultimo estratto nel display centrale
            if (ultimoID) {
                const p = personaggiiDB.find(x => x.id == ultimoID);
                document.getElementById('numero-estratto').innerText = p.id;
                document.getElementById('nome-estratto').innerText = p.nome;
            }

            // Generiamo la lista unica con i colori differenti
            listaDiv.innerHTML = personaggiiDB
                .sort((a,b) => a.id - b.id)
                .map(p => `
                    <div class="box ${p.estratto ? 'estratto' : 'rimanente'}">
                        ${p.id} <span>${p.nome}</span>
                    </div>
                `).join('');

            // Gestione Timer
            const mancano = Math.max(0, Math.ceil((ultima + ATTESA_MS - Date.now()) / 1000));
            const btn = document.getElementById('btn-estrai');
            const rimasti = personaggiiDB.filter(p => !p.estratto).length;

            if (rimasti === 0) {
                btn.disabled = true;
                btn.innerText = "COMPLETATO";
            } else if (mancano > 0) {
                btn.disabled = true;
                document.getElementById('messaggio').innerText = `Attendi ${mancano}s...`;
                setTimeout(aggiornaUI, 1000);
            } else {
                btn.disabled = false;
                btn.innerText = "ESTRAI ORA";
                document.getElementById('messaggio').innerText = "";
            }
        }

        function avviaEstrazione() {
            const numDisplay = document.getElementById('numero-estratto');
            numDisplay.classList.add('rolling');
            
            let counter = 0;
            const loop = setInterval(() => {
                numDisplay.innerText = Math.floor(Math.random() * 99);
                if (++counter > 15) {
                    clearInterval(loop);
                    numDisplay.classList.remove('rolling');
                    eseguiLogica();
                }
            }, 70);
        }

        function eseguiLogica() {
            const disponibili = personaggiiDB.filter(p => !p.estratto);
            if (disponibili.length === 0) return;

            const scelto = disponibili[Math.floor(Math.random() * disponibili.length)];
            
            // AGGIORNIAMO IL JSON (nello stato locale)
            scelto.estratto = true; // Imposta estratto su true

            localStorage.setItem('ultimo_id', scelto.id);
            localStorage.setItem('ultimo_ts', Date.now());
            salvaDati();
            aggiornaUI();
        }

        init();
    </script>
</body>
</html>
